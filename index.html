<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Catálogo Optimarket</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .search-container {
        position: sticky;
        top: 1rem;
        z-index: 50;
        margin-bottom: 2rem;
      }
      .hidden {
        display: none !important;
      }
      .step-content {
        display: none;
      }
      .step-content.active {
        display: block;
        animation: fadeIn 0.3s ease-out;
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <p style="margin-top: 1rem; font-weight: 500">
        Cargando...
      </p>
    </div>

    <button class="theme-toggle glass" id="themeToggle">
      <i class="fas fa-moon"></i>
    </button>

    <!-- Hidden Form for Silent Visit Tracking -->
    <form name="visitas" netlify netlify-honeypot="bot-field" hidden>
      <input type="text" name="optica" />
      <input type="text" name="fecha" />
    </form>

    <div class="container animate-fade-in">
      <header style="margin-bottom: 2rem">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <h1 class="text-gradient" style="font-size: 2.2rem">OPTIMARKET S.R.L</h1>
            <p
              id="welcomeMessage"
              style="color: var(--text-muted); font-size: 0.9rem"
            ></p>
          </div>
          <button
            id="logoutBtn"
            class="glass"
            style="
              padding: 0.5rem 1rem;
              border-radius: 12px;
              cursor: pointer;
              color: var(--text-muted);
              border: none;
            "
          >
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </header>

      <!-- Steps Indicator -->
      <div class="steps">
        <div class="step active" id="step1-indicator">
          <div class="step-circle">1</div>
          <div class="step-label">Categoría</div>
        </div>
        <div class="step" id="step2-indicator">
          <div class="step-circle">2</div>
          <div class="step-label">Producto</div>
        </div>
        <div class="step" id="step3-indicator">
          <div class="step-circle">3</div>
          <div class="step-label">Precio</div>
        </div>
      </div>

      <main>
        <!-- Step 1: Category Selection -->
        <section id="step1" class="step-content active">
          <div
            class="glass-card"
            style="text-align: center; padding: 3rem 1rem"
          >
            <h2 style="margin-bottom: 2rem">¿Qué buscas hoy?</h2>
            <div
              style="
                display: grid;
                gap: 1rem;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
              "
            >
              <button
                class="btn glass category-btn"
                data-cat="Lentilla"
                style="height: 120px; flex-direction: column"
              >
                <i
                  class="fas fa-eye"
                  style="font-size: 1.5rem; margin-bottom: 0.5rem"
                ></i>
                <span>ORGANICOS</span>
              </button>
              <button
                class="btn glass category-btn"
                data-cat="Material Listo"
                style="height: 120px; flex-direction: column"
              >
                <i
                  class="fas fa-glasses"
                  style="font-size: 1.5rem; margin-bottom: 0.5rem"
                ></i>
                <span>BIFOCALES TERMINADO</span>
              </button>
              <button
                class="btn glass category-btn"
                data-cat="Block"
                style="height: 120px; flex-direction: column"
              >
                <i
                  class="fas fa-box"
                  style="font-size: 1.5rem; margin-bottom: 0.5rem"
                ></i>
                <span>BLOCK</span>
              </button>
            </div>
          </div>
        </section>

        <!-- Step 2: Product & Measure Selection -->
        <section id="step2" class="step-content">
          <div class="glass-card">
            <button
              class="btn glass"
              onclick="goToStep(1)"
              style="margin-bottom: 1.5rem; padding: 0.5rem 1rem"
            >
              <i class="fas fa-arrow-left"></i> Volver
            </button>
            <div class="form-group">
              <label class="form-label">Subcategoría (Producto)</label>
              <div class="autocomplete-container">
                <input
                  type="text"
                  id="productInput"
                  class="form-input"
                  placeholder="Escribe para buscar producto..."
                  autocomplete="off"
                />
                <div id="productSuggestions" class="suggestions-list"></div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Medida</label>
              <div class="autocomplete-container">
                <input
                  type="text"
                  id="measureInput"
                  class="form-input"
                  placeholder="Escribe para buscar medida..."
                  autocomplete="off"
                  disabled
                />
                <div id="measureSuggestions" class="suggestions-list"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Step 3: Calculation & Add to Proforma -->
        <section id="step3" class="step-content">
          <div id="priceDisplay"></div>
        </section>
      </main>
    </div>

    <!-- Floating Proforma Button -->
    <div id="proformaBtn" class="proforma-badge hidden">
      <i class="fas fa-file-invoice-dollar"></i>
      <span>Ver Proforma (<span id="cartCount">0</span>)</span>
    </div>

    <!-- Proforma Modal -->
    <div class="modal-overlay" id="proformaModal">
      <div class="modal-content glass-card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
          "
        >
          <h2>Tu Proforma</h2>
          <button
            class="btn glass"
            id="closeProforma"
            style="padding: 0.5rem; border-radius: 50%"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="cartItems" style="margin-bottom: 2rem">
          <!-- Items go here -->
        </div>
        <div
          style="
            border-top: 1px solid var(--border-glass);
            padding-top: 1.5rem;
            margin-bottom: 2rem;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 1.25rem;
              font-weight: 700;
            "
          >
            <span>Total General</span>
            <span id="cartTotal">0 Bs.</span>
          </div>
        </div>
        <div style="display: grid; gap: 1rem">
          <button class="btn btn-primary" id="sendWhatsApp" style="width: 100%">
            <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
          </button>
          <button
            class="btn glass"
            id="clearCart"
            style="width: 100%; color: #ef4444"
          >
            <i class="fas fa-trash"></i> Vaciar Proforma
          </button>
        </div>
      </div>
    </div>

    <script src="app.js"></script>
    <script>
      // Check session
      const client = JSON.parse(localStorage.getItem("registeredClient"));
      if (!client) {
        window.location.href = "form.html";
      } else {
        document.getElementById("welcomeMessage").innerText =
          `Cotización para ${client.optica}`;
        // Silent visit tracking
        if (window.location.hostname !== "localhost") {
          const formData = new FormData();
          formData.append("form-name", "visitas");
          formData.append("optica", client.optica);
          formData.append("fecha", new Date().toLocaleString());
          fetch("/", { method: "POST", body: new URLSearchParams(formData) });
        }
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("registeredClient");
        window.location.href = "form.html";
      });

      // Modals & Floating Btn
      const modal = document.getElementById("proformaModal");
      const cartBtn = document.getElementById("proformaBtn");
      cartBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        renderCart();
      });
      document
        .getElementById("closeProforma")
        .addEventListener("click", () => (modal.style.display = "none"));
      window.addEventListener("click", (e) => {
        if (e.target === modal) modal.style.display = "none";
      });

      // Theme Toggle logic remains the same
      const themeBtn = document.getElementById("themeToggle");
      themeBtn.addEventListener("click", () => {
        const isDark = document.body.getAttribute("data-theme") === "dark";
        document.body.setAttribute("data-theme", isDark ? "light" : "dark");
        themeBtn.innerHTML = isDark
          ? '<i class="fas fa-moon"></i>'
          : '<i class="fas fa-sun"></i>';
        localStorage.setItem("theme", isDark ? "light" : "dark");
      });
      if (localStorage.getItem("theme") === "dark") {
        document.body.setAttribute("data-theme", "dark");
        themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
      }
    </script>
  </body>
</html>
